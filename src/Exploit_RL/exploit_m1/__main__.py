import time
import pickle
from itertools import product
from multiprocessing import cpu_count
import numpy as np
from .config import FixedArgs, FreeArgs
from .core import MultiAgentExploit
from .. import parallel_simulations

if __name__ == "__main__":
    args = FixedArgs()
    free_params = FreeArgs()
    seed = 12345

    # Grid resolution
    step_scale10 = args.step * 10
    
    # Values
    update_timescale_values = np.arange(0, 10 + step_scale10, step_scale10, dtype=float)
    rationality_values = np.arange(0, 10 + step_scale10, step_scale10, dtype=float)
    
    # Non-zero
    eps = 0.01
    update_timescale_values[0] += eps
    
    # Resume
    print('===================================')
    num_params = len(rationality_values) * len(update_timescale_values) 
    print(f'Number of parameters: {num_params}')
    print(f'Number of simulations: {args.num_simulations}')
    print(f'--- hence {num_params * args.num_simulations} parallel processes')
    print(f'Number of agents: {args.num_agents} (vectorized)')
    print(f'Number of CPU logical processors: {cpu_count()}')
    print('===================================')

    # Simulate for all coordinates
    param_grid = list(product(update_timescale_values, rationality_values))

    results = {}
    total_time = 0
    for i, (update_timescale, rationality) in enumerate(param_grid):
        progress = (i / num_params) * 100
        print()
        print(f"Running simulations for r={rationality}, tau={update_timescale} (total {progress:.2f}% complete)")
        start_single_bsimul = time.time()
        
        # Current parameters
        free_params.update_timescale = update_timescale
        free_params.rationality = rationality
        
        # Run simulations
        params, mean_result = parallel_simulations(seed, free_params, args, MultiAgentExploit)
        results[params] = mean_result
        
        time_single_bsimul = time.time() - start_single_bsimul
        total_time += time_single_bsimul
        remaining_time = (num_params-i) * total_time / (i+1)
        print(f"---simulation batch completed in {time_single_bsimul:.2f} seconds")
        print(f"---on average {total_time / (i+1):.2f} seconds, expected remaining time: {remaining_time/60:.2f} minutes")

    print()
    print(f"Completed all simulations in {total_time/60:.2f} minutes")
    
    with open(args.file_name, mode='wb') as file:
        pickle.dump(results, file)
    print('Results saved')